= Configuring Deploys
:page-layout: classic-docs
:page-liquid:
:icons: font
:toc: macro
:toc-title:

Deployment at CircleCI is treated just the same as any other job configuration, meaning you can configure your project to deploy to virtually any target. This document provides an overview of the deployment process, along with best practices and optimization strategies.

toc::[]

[discrete]
== Overview

Once a software application has been developed and tested, it needs to be deployed and made available for its intended audience. CircleCI can be configured to deploy to any target, and can be easily configured to integrate with other services for processes such as UI QA/testing, feature management tools, multiple deployment targets (for example, staging/production). Quickly and easily customize your config to match your deployment strategy, whether a fully automated process or elements of manual approval are required.

.Deployment
image::pipeline-to-deployment.png[Deployment]

=== Simple Deployments Using Orbs

Orbs are available for many common deployment targets to help simplify and streamline your config. Orbs are packages of reusable configuration, and often, for simple pipelines, simply invoking an orb, including a pre-configured job, and setting any requires environment variables/SSH keys within your project, will get you the results you need with no further configuration. 

=== A Simple Example Using Heroku

Below is a simple example of deploying a Rails application to Heroku. The full application can be found in the https://github.com/CircleCI-Public/circleci-demo-workflows/tree/sequential-branch-filter[Sequential Job branch of the CircleCI Demo Workflows repository].

```yaml
version: 2

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: sequential-branch-filter

jobs:
  build:
    docker:
      - image: circleci/ruby:2.4-node-jessie
      - image: circleci/postgres:9.4.12-alpine
    working_directory: ~/circleci-demo-workflows
    steps:
      - checkout
      - run: bundle install --path vendor/bundle  # install dependencies
      - run: bundle exec rake db:create db:schema:load  # setup database
      - run:
          name: Run tests
          command: rake

  deploy:
    machine:
        enabled: true
    working_directory: ~/circleci-demo-workflows
    environment:
      HEROKU_APP: "sleepy-refuge-55486"
    steps:
      - checkout
      - run:
          name: Deploy Master to Heroku
          command: |
            git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP.git master
```

The configuration uses {{ site.baseurl }}/2.0/workflows/[workflows] to deploy only if the `sequential-branch-filter` branch is checked out and the `build` job has run. If your deploy job uses any output from previous jobs, you can share that data by [using workspaces]({{ site.baseurl }}/2.0/workflows/#using-workspaces-to-share-data-among-jobs). For more information on conditional deploys, see [Using Contexts and Filtering in your Workflows]({{ site.baseurl }}/2.0/workflows/#using-contexts-and-filtering-in-your-workflows).

Below is the same Heroku Deployment example but using the Heroku orb to simplify the configuration:

```yaml
version: 2.1
orbs:
  heroku: circleci/heroku@0.0.10. # We, CPE should get a major 1.0 release out before docs go live
workflows:
  heroku_deploy:
    jobs:
      - build
      - heroku/deploy-via-git:
          requires:
            - build
          filters:
            branches:
              only: sequential-branch-filter
jobs:
  build:
    docker:
      - image: circleci/ruby:2.4-node
      - image: circleci/postgres:9.4.12-alpine
    working_directory: ~/circleci-demo-workflows
    steps:
      - checkout
      # Bundle install dependencies
      - run: bundle install --path vendor/bundle
      # Database setup
      - run: bundle exec rake db:create db:schema:load
      - run:
          name: Run tests
          command: rake
```

== Deployment: The Basics

* To deploy your application, add a [job]({{ site.baseurl }}/2.0/jobs-steps/#jobs-overview) to your `.circleci/config.yml` file and configure the job to run the steps required to deploy your application.

* To fulfill the deploy steps you will need to [add environment variables]({{ site.baseurl }}/2.0/env-vars/#setting-an-environment-variable-in-a-project) and/or [SSH keys]({{ site.baseurl }}/2.0/add-ssh-key/) for your specific deployment target. These can be added to the project itself, or defined within your configuration.

* For an example of defining environment variables within your configuration see the non-orbs example above, within the deploy job configuration we have:
+
```
environment:
      HEROKU_APP: "sleepy-refuge-55486"
```
+
Alternatively, the `HEROKU_APP` variable could be defined within you project, via the **Project Settings** page in the UI.

* Another example, using the Heroku orb example above, looking at the [orb's page in the registry](https://circleci.com/orbs/registry/orb/circleci/heroku) we can see that within the orb the `HEROKU_APP_NAME` env var is used, and the single line deployment shown above – `- heroku/deploy-via-git:` – relies on the env var being defined within the project already, but it could also be defined within the config if required, as an orb parameter, using the following customization:
+
```yaml
version: 2.1
orbs:
  heroku: circleci/heroku@0.0.10. # We, CPE should get a major 1.0 release out before docs go live
workflows:
  heroku_deploy:
    jobs:
      - build
      - deploy_heroku:
          requires:
            - build
          filters:
            branches:
              only: sequential-branch-filter
jobs:
  build: 
    docker:
      - image: circleci/ruby:2.4-node
      - image: circleci/postgres:9.4.12-alpine
    working_directory: ~/circleci-demo-workflows
    steps: # Steps ommitted for brevity
  deploy_heroku:
    executor: heroku/default
    steps:
      - checkout
      - heroku/install
      - heroku/deploy-via-git:
          app-name: "sleepy-refuge-55486"
```




